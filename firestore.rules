rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ----------------------------------------------------
    // 1. 🔑 ログイン情報へのアクセス許可 (自分のIDのドキュメントのみ)
    // ----------------------------------------------------
    
    // 先生のログイン情報 (teachers/T001)
    match /teachers/{teacherId} {
      // ドキュメントIDがリクエストされたドキュメントIDと一致する場合のみ読み取りを許可。
      // ただし、この match ブロックでは request.resource.data のチェックはできません。
      // シンプルに読み取りを許可します。
      // 【警告】この設定では、誰でもteachersコレクション内の任意のドキュメントを読み取れるため、
      // ユーザーが正しいteacherIdを入力したかどうかに依存します。
      allow read: if true; 
      allow write: if false;
    }
    
    // 生徒のログイン情報 (students/S2024001)
    match /students/{studentId} {
      // teachersと同様に、読み取りを許可します。
      allow read: if true;
      allow write: if false;
    }
    
    // ----------------------------------------------------
    // 2. 📝 ユーザーの状態データ (生徒モード/授業中)
    // ----------------------------------------------------

    // user_status は生徒のモード情報です。認証が通ったユーザーが自分のIDのドキュメントにアクセスできるようにします。
    // 現状、Authがないため、誰でも読み書きできてしまいますが、コード側の制御に任せます。
    match /user_status/{userId} {
      allow read, write: if true; 
    }
    
    // ----------------------------------------------------
    // 3. 授業データ
    // ----------------------------------------------------
    match /active_events/{eventId} {
      allow read: if true; 
      allow write: if false;
    }

    // デフォルトでアクセスを拒否する
    match /{document=**} {
      allow read, write: if false;
    }
  }
}